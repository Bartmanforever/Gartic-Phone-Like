<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scrum Phone</title>
    <style>
        :root {
            --primary: #6d5dfc; --secondary: #e4ebf5; --accent: #f9ca24;
            --danger: #ff7675; --dark: #2d3436; --shadow: 8px 8px 16px #d1d9e6, -8px -8px 16px #ffffff;
        }

        body {
            font-family: 'Segoe UI', sans-serif; background-color: var(--secondary);
            color: var(--dark); margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding-bottom: 140px;
        }

        #timer-bar { width: 100%; height: 8px; background: #ccc; position: fixed; top: 0; z-index: 1000; }
        #timer-progress { width: 0%; height: 100%; background: var(--primary); transition: width 1s linear; }

        .container {
            width: 90%; max-width: 850px; background: var(--secondary);
            padding: 2rem; border-radius: 30px; box-shadow: var(--shadow);
            margin-top: 40px; text-align: center; position: relative;
        }

        input, select {
            padding: 12px; border: none; border-radius: 10px; background: var(--secondary);
            box-shadow: inset 2px 2px 5px #b1b9c9, inset -5px -5px 10px #ffffff; margin: 10px; outline: none;
        }

        button {
            padding: 12px 25px; border: none; border-radius: 15px; background: var(--primary);
            color: white; font-weight: bold; cursor: pointer;
            box-shadow: 3px 3px 6px #b8b9be, -3px -3px 6px #ffffff; transition: 0.2s;
        }

        button:hover { transform: translateY(-2px); filter: brightness(1.1); }
        button.btn-admin { background: var(--accent); color: var(--dark); }
        button.btn-danger { background: var(--danger); }
        button.btn-hard { background: #2d3436; color: white; }

        #persistent-admin-panel {
            position: fixed; bottom: 0; left: 0; right: 0; background: #dfe6e9;
            padding: 15px; box-shadow: 0 -5px 15px rgba(0,0,0,0.1);
            display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap;
            z-index: 999; border-top: 4px solid var(--accent);
        }

        .hidden { display: none !important; }
        #canvas-container { background: white; border-radius: 20px; margin: 20px auto; width: 500px; box-shadow: inset 2px 2px 10px rgba(0,0,0,0.1); }
        canvas { border-radius: 20px; touch-action: none; cursor: crosshair; }
        
        .toolbar { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin: 15px 0; }
        .color-dot { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; }
        .color-dot.active { border-color: var(--primary); transform: scale(1.1); }
        .result-img { max-width: 100%; border-radius: 10px; margin: 10px 0; border: 1px solid #ddd; }
    </style>
</head>
<body>

    <div id="timer-bar"><div id="timer-progress"></div></div>

    <div class="container">
        <h1>üìû Scrum Phone <small style="font-size: 0.4em; opacity: 0.5;"></h1>

        <div id="screen-login">
            <input type="text" id="login-name" placeholder="Ton Pr√©nom"><br>
            <input type="password" id="login-pass" placeholder="Password Admin"><br>
            <button id="btn-join-player">Joueur</button>
            <button id="btn-join-admin" class="btn-admin">Admin</button>
        </div>

        <div id="screen-lobby" class="hidden">
            <div id="player-list" style="margin: 20px 0; font-weight: bold; font-size: 1.1rem;"></div>
            <p>En attente du lancement...</p>
        </div>

        <div id="timer-display" class="hidden" style="font-size: 2.5rem; font-weight: bold;">--</div>

        <div id="screen-write" class="hidden">
            <h3>üìù √âcris une phrase :</h3>
            <p id="phrase-suggestion" style="font-style: italic; color: #7f8c8d;"></p>
            <input type="text" id="input-phrase" placeholder="..." style="width:80%;">
            <br><button id="btn-submit-phrase">Envoyer</button>
        </div>

        <div id="screen-draw" class="hidden">
            <h3>üé® Dessine : <span id="text-to-draw" style="color:var(--primary)">...</span></h3>
            <div id="canvas-container"><canvas id="paintCanvas" width="500" height="400"></canvas></div>
            <div class="toolbar">
                <select id="brush-size"><option value="2">Fin</option><option value="5" selected>Normal</option><option value="12">Gros</option></select>
                <div id="palette" style="display: flex; gap: 5px;"></div>
                <button class="color-dot" style="background:#fff; border:1px solid #ccc;" onclick="setEraser()">üßº</button>
            </div>
            <button onclick="clearCanvas()">Vider</button>
            <button id="btn-submit-draw">Termin√©</button>
        </div>

        <div id="screen-guess" class="hidden">
            <h3>ü§î Qu'est-ce que c'est ?</h3>
            <img id="img-to-guess" class="result-img" src=""><br>
            <input type="text" id="input-guess" placeholder="Ta r√©ponse..."><br>
            <button id="btn-submit-guess">Valider</button>
        </div>

        <div id="screen-wait" class="hidden">‚è≥ On attend les autres...</div>

        <div id="screen-results" class="hidden">
            <h2>üèÜ Album de la partie</h2>
            <div id="results-gallery"></div>
        </div>
    </div>

    <div id="persistent-admin-panel" class="hidden">
        <input type="number" id="cfg-timer" value="45" style="width:50px;">
        <button id="btn-start-game" class="btn-admin">LANCER</button>
        <button id="btn-reset-round" class="btn-danger" style="background:#e67e22;">ROUND</button>
        <button id="btn-reset-players" class="btn-danger">SALON</button>
        <button id="btn-reset-hard" class="btn-hard">HARD</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, get, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCxZY1l6bfC7rXO02JtOwuauGviNSTkhYA",
            authDomain: "telephone-arabe.firebaseapp.com",
            databaseURL: "https://telephone-arabe-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "telephone-arabe",
            storageBucket: "telephone-arabe.firebasestorage.app",
            messagingSenderId: "227254624373",
            appId: "1:227254624373:web:fa1542bc7551a1083fd83c"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const myId = 'u' + Math.floor(Math.random() * 1000000);
        let myName = "", isAdmin = false, players = [], isLogged = false;

        const suggestions = ["Un chat ninja", "Pizza spatiale", "Elon Musk sur Mars", "Poney volant"];

        // Auth
        document.getElementById('btn-join-player').onclick = () => login(false);
        document.getElementById('btn-join-admin').onclick = () => {
            if(document.getElementById('login-pass').value === "admin") login(true);
            else alert("Acc√®s Admin refus√©");
        };

        function login(isAdm) {
            myName = document.getElementById('login-name').value || "Joueur";
            isAdmin = isAdm;
            isLogged = true;
            set(ref(db, `game_v8/players/${myId}`), { name: myName, isAdmin: isAdm });
            onDisconnect(ref(db, `game_v8/players/${myId}`)).remove();
            if(isAdmin) document.getElementById('persistent-admin-panel').classList.remove('hidden');
            showScreen('screen-lobby');
        }

        // Admin
        document.getElementById('btn-start-game').onclick = () => {
            if(!isAdmin) return;
            let dur = parseInt(document.getElementById('cfg-timer').value);
            update(ref(db, 'game_v8'), { state: "WRITE", timer: dur, maxTime: dur, books: null });
        };

        document.getElementById('btn-reset-round').onclick = () => {
            if(isAdmin) { remove(ref(db, 'game_v8/books')); update(ref(db, 'game_v8'), { state: "LOBBY", timer: -1 }); }
        };

        document.getElementById('btn-reset-players').onclick = async () => {
            if(isAdmin && confirm("Vider le salon ?")) {
                await remove(ref(db, 'game_v8'));
                set(ref(db, `game_v8/players/${myId}`), { name: myName, isAdmin: true });
                update(ref(db, 'game_v8'), { state: "LOBBY", timer: -1 });
            }
        };

        document.getElementById('btn-reset-hard').onclick = () => {
            if(isAdmin && confirm("HARD RESET ?")) remove(ref(db, 'game_v8')).then(() => location.reload());
        };

        // Sync
        onValue(ref(db, 'game_v8/timer'), async (snap) => {
            const t = snap.val(); const display = document.getElementById('timer-display');
            if(t !== null && t >= 0) {
                display.classList.remove('hidden'); display.innerText = t;
                if(t === 0) forceSubmit();
            } else display.classList.add('hidden');
        });

        onValue(ref(db, 'game_v8/state'), (snap) => {
            const s = snap.val(); if(!s) return;
            if(s === "LOBBY") showScreen('screen-lobby');
            if(s === "WRITE") { showScreen('screen-write'); document.getElementById('phrase-suggestion').innerText = "Ex : " + suggestions[Math.floor(Math.random()*suggestions.length)]; }
            if(s === "DRAW") startDrawPhase();
            if(s === "GUESS") startGuessPhase();
            if(s === "RESULTS") showResults();
        });

        onValue(ref(db, 'game_v8/players'), (snap) => {
            const data = snap.val(); players = data ? Object.keys(data) : [];
            document.getElementById('player-list').innerHTML = data ? Object.values(data).map(p => p.name).join(" ‚Äî ") : "Salon vide";
            // LA CORRECTION EST ICI : On ne check le kick que si l'utilisateur est d√©j√† logg√©
            if (isLogged && players.length > 0 && !players.includes(myId)) {
                location.reload();
            }
        });

        // Flow simple
        function showScreen(id) {
            document.querySelectorAll('.container > div:not(#timer-display)').forEach(d => d.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        document.getElementById('btn-submit-phrase').onclick = async () => {
            await set(ref(db, `game_v8/books/${myId}/step0`), { content: document.getElementById('input-phrase').value || "Myst√®re", author: myName });
            checkNext("DRAW");
        };

        async function startDrawPhase() {
            const snap = await get(ref(db, `game_v8/books/${getTId(1)}/step0`));
            document.getElementById('text-to-draw').innerText = snap.val() ? snap.val().content : "...";
            showScreen('screen-draw'); clearCanvas();
        }

        document.getElementById('btn-submit-draw').onclick = async () => {
            await set(ref(db, `game_v8/books/${getTId(1)}/step1`), { content: canvas.toDataURL('image/png'), author: myName });
            checkNext("GUESS");
        };

        async function startGuessPhase() {
            const snap = await get(ref(db, `game_v8/books/${getTId(2)}/step1`));
            document.getElementById('img-to-guess').src = snap.val() ? snap.val().content : "";
            showScreen('screen-guess');
        }

        document.getElementById('btn-submit-guess').onclick = async () => {
            await set(ref(db, `game_v8/books/${getTId(2)}/step2`), { content: document.getElementById('input-guess').value || "Rien", author: myName });
            checkNext("RESULTS");
        };

        async function checkNext(next) {
            showScreen('screen-wait');
            if(!isAdmin) return;
            const itv = setInterval(async () => {
                const snap = await get(ref(db, 'game_v8/books'));
                const books = snap.val() || {};
                const step = next === "DRAW" ? "step0" : (next === "GUESS" ? "step1" : "step2");
                if(Object.values(books).filter(b => b[step]).length === players.length) {
                    clearInterval(itv);
                    let dur = parseInt(document.getElementById('cfg-timer').value);
                    update(ref(db, 'game_v8'), { state: next, timer: dur });
                    let c = dur;
                    let timerLoop = setInterval(() => {
                        c--; update(ref(db, 'game_v8'), { timer: c });
                        if(c <= 0) clearInterval(timerLoop);
                    }, 1000);
                }
            }, 2000);
        }

        function getTId(off) { const idx = players.indexOf(myId); return players[(idx + off) % players.length]; }
        function forceSubmit() {
            const current = document.querySelector('.container > div:not(.hidden)');
            if(current.id === 'screen-write') document.getElementById('btn-submit-phrase').click();
            if(current.id === 'screen-draw') document.getElementById('btn-submit-draw').click();
            if(current.id === 'screen-guess') document.getElementById('btn-submit-guess').click();
        }

        // Draw
        const canvas = document.getElementById('paintCanvas'); const ctx = canvas.getContext('2d');
        let painting = false, brushColor = "#000000";
        const colors = ["#000000", "#e74c3c", "#3498db", "#2ecc71", "#f1c40f", "#e67e22", "#9b59b6", "#795548", "#ff9ff3", "#00d2d3"];
        colors.forEach(c => {
            const dot = document.createElement('div'); dot.className = 'color-dot'; dot.style.background = c;
            dot.onclick = () => { brushColor = c; document.querySelectorAll('.color-dot').forEach(d=>d.classList.remove('active')); dot.classList.add('active'); };
            document.getElementById('palette').appendChild(dot);
        });
        canvas.onmousedown = (e) => { painting = true; draw(e); };
        canvas.onmouseup = () => { painting = false; ctx.beginPath(); };
        canvas.onmousemove = draw;
        function draw(e) {
            if (!painting) return; 
            ctx.lineWidth = document.getElementById('brush-size').value; 
            ctx.lineCap = 'round'; ctx.strokeStyle = brushColor;
            const rect = canvas.getBoundingClientRect(); ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            ctx.stroke(); ctx.beginPath(); ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }
        window.setEraser = () => { brushColor = "#ffffff"; };
        window.clearCanvas = () => ctx.clearRect(0, 0, canvas.width, canvas.height);

        async function showResults() {
            showScreen('screen-results');
            const snap = await get(ref(db, 'game_v8/books')); const books = snap.val();
            const gal = document.getElementById('results-gallery'); gal.innerHTML = "";
            for (let id in books) {
                const b = books[id]; if(!b.step0 || !b.step1 || !b.step2) continue;
                gal.innerHTML += `<div style="border-bottom:2px solid #ccc; padding:20px; text-align:left;">
                    <p><b>${b.step0.author}</b> : "${b.step0.content}"</p>
                    <img class="result-img" src="${b.step1.content}">
                    <p><b>${b.step2.author}</b> a vu : <b>"${b.step2.content}"</b></p>
                </div>`;
            }
        }
    </script>
</body>
</html>
