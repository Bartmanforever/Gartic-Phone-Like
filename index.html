<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scrum Phone - Mario Kart Edition</title>
    <style>
        :root {
            --mk-blue: #0055aa;
            --mk-light-blue: #00aaff;
            --mk-yellow: #fff200;
            --mk-red: #ff0000;
            --mk-dark: #1a1a1a;
            --mk-white: #ffffff;
            --mk-gradient: linear-gradient(180deg, #0055aa 0%, #002244 100%);
        }

        body {
            font-family: 'Arial Black', sans-serif;
            background: var(--mk-gradient);
            background-attachment: fixed;
            color: var(--mk-white);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding-bottom: 200px;
        }

        /* TIMER MK STYLE - Correction affichage */
        #timer-container {
            position: sticky; top: 0; width: 100%; 
            background: rgba(0, 0, 0, 0.8);
            border-bottom: 4px solid var(--mk-yellow);
            z-index: 1000; padding: 15px 0;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        #timer-bar { width: 80%; height: 12px; background: #333; margin: 10px auto; border-radius: 20px; border: 2px solid var(--mk-white); }
        #timer-progress { width: 0%; height: 100%; background: linear-gradient(90deg, var(--mk-red), var(--mk-yellow)); border-radius: 20px; transition: width 1s linear; }
        #timer-display { font-size: 3rem; font-weight: 900; color: var(--mk-white); font-style: italic; text-shadow: 3px 3px 0 var(--mk-red); }

        .container {
            width: 90%; max-width: 850px; 
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 2.5rem; border-radius: 20px; 
            border: 4px solid var(--mk-white);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            margin-top: 30px; text-align: center;
        }

        h1 {
            font-size: 3.5rem; color: var(--mk-white); font-style: italic;
            text-shadow: 4px 4px 0 var(--mk-blue), 8px 8px 0 rgba(0,0,0,0.5);
            margin-bottom: 30px; transform: skewX(-5deg);
        }

        /* CONNEXION */
        .login-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 20px; }
        @media (max-width: 600px) { .login-grid { grid-template-columns: 1fr; } }
        
        .login-card { 
            padding: 30px; border-radius: 15px; background: var(--mk-white); color: var(--mk-dark);
            border: 4px solid var(--mk-blue); box-shadow: 8px 8px 0 rgba(0,0,0,0.2);
            transition: 0.2s;
        }
        .login-card:hover { transform: scale(1.02); }
        .login-card.admin-zone { border-color: var(--mk-red); }
        .login-card h2 { margin-top: 0; color: var(--mk-blue); font-style: italic; font-size: 1.8rem; }

        input {
            padding: 15px; border: 3px solid var(--mk-blue); border-radius: 10px; 
            background: #f0f0f0; color: #000; margin: 10px 0; outline: none; 
            font-size: 1.2rem; width: 90%; font-weight: bold;
        }

        button {
            padding: 18px 30px; border: none; border-radius: 50px; 
            background: var(--mk-blue); color: white; font-weight: 900; 
            cursor: pointer; font-size: 1.2rem; text-transform: uppercase; 
            box-shadow: 0 6px 0 #003366; transition: 0.1s; margin: 10px;
            font-style: italic;
        }
        button:active { transform: translateY(4px); box-shadow: 0 2px 0 #003366; }
        button.btn-admin { background: var(--mk-red); box-shadow: 0 6px 0 #990000; }
        button.btn-danger { background: #444; box-shadow: 0 6px 0 #222; }

        /* ADMIN PANEL - JAUNE KART */
        #persistent-admin-panel {
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: var(--mk-yellow); color: var(--mk-dark);
            padding: 20px; display: flex; flex-wrap: wrap; justify-content: center; align-items: center;
            gap: 20px; z-index: 2000; border-top: 6px solid var(--mk-white);
        }
        .admin-group { background: var(--mk-white); padding: 12px 25px; border-radius: 10px; border: 3px solid var(--mk-dark); display: flex; align-items: center; gap: 10px; }
        .reset-zone { border-left: 3px solid rgba(0,0,0,0.1); padding-left: 20px; display: flex; gap: 10px; }

        .hidden { display: none !important; }

        /* ZONE DE DESSIN ET IMAGE : BLANC IMP√âRATIF */
        #canvas-container { 
            background: #ffffff !important; 
            border-radius: 15px; margin: 20px auto; 
            width: 100%; max-width: 600px; border: 5px solid var(--mk-blue); overflow: hidden;
        }
        canvas { touch-action: none; cursor: crosshair; display: block; width: 100%; background: #ffffff !important; }
        
        .result-img { 
            width: 100%; border-radius: 10px; border: 2px solid #ccc; 
            background: #ffffff !important; /* Fond blanc pour l'image √† deviner */
            display: block;
        }

        .toolbar { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin: 15px 0; }
        .color-dot { width: 45px; height: 45px; border-radius: 50%; cursor: pointer; border: 3px solid var(--mk-white); box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        .color-dot.active { border-color: var(--mk-yellow); transform: scale(1.2); }
        
        .result-card { 
            background: var(--mk-white); color: var(--mk-dark); padding: 25px; border-radius: 15px; 
            margin-bottom: 30px; text-align: left; border-left: 10px solid var(--mk-blue);
        }
        .step-info { font-size: 1.2rem; margin: 15px 0; font-weight: bold; color: var(--mk-blue); }
        .blink { animation: blinker 0.8s linear infinite; }
        @keyframes blinker { 50% { opacity: 0.3; } }
    </style>
</head>
<body>

    <div id="timer-container" class="hidden">
        <div id="timer-display">--</div>
        <div id="timer-bar"><div id="timer-progress"></div></div>
    </div>

    <div class="container">
        <h1>SCRUM PHONE</h1>

        <div id="screen-login">
            <div class="login-grid">
                <div class="login-card">
                    <h2>üèÅ JOUEUR</h2>
                    <input type="text" id="login-name" placeholder="TON PR√âNOM">
                    <button id="btn-join-player" style="width: 100%;">C'EST PARTI !</button>
                </div>
                <div class="login-card admin-zone">
                    <h2>üèÜ ADMIN</h2>
                    <input type="text" id="admin-name" placeholder="TON PR√âNOM">
                    <input type="password" id="admin-pass" placeholder="CODE">
                    <button id="btn-join-admin" class="btn-admin" style="width: 100%;">MODE HOST</button>
                </div>
            </div>
        </div>

        <div id="screen-lobby" class="hidden">
            <div id="player-list" style="margin: 30px 0; font-size: 2rem; color: var(--mk-yellow);"></div>
            <p class="blink" style="font-size: 1.5rem;">EN ATTENTE SUR LA LIGNE DE D√âPART...</p>
        </div>

        <div id="screen-write" class="hidden">
            <h3>üìù √âCRIS UNE PHRASE :</h3>
            <p id="phrase-suggestion" style="color: var(--mk-yellow);"></p>
            <input type="text" id="input-phrase" placeholder="Ton id√©e...">
            <br><button id="btn-submit-phrase">VALIDER</button>
        </div>

        <div id="screen-draw" class="hidden">
            <h3 style="color: var(--mk-yellow);">üé® <span id="draw-instruction">...</span></h3>
            <div id="canvas-container"><canvas id="paintCanvas" width="600" height="450"></canvas></div>
            <div class="toolbar">
                <select id="brush-size" style="padding: 10px; border-radius: 10px; font-weight: bold;">
                    <option value="3">FIN</option><option value="7" selected>MOYEN</option><option value="15">GROS</option>
                </select>
                <div id="palette" style="display: flex; gap: 8px;"></div>
                <button class="color-dot" style="background:#fff; display:flex; align-items:center; justify-content:center;" onclick="setEraser()">üßº</button>
            </div>
            <button onclick="clearCanvas()" style="background:#666;">EFFACER TOUT</button>
            <button id="btn-submit-draw" style="background: var(--mk-red);">TERMIN√â !</button>
        </div>

        <div id="screen-guess" class="hidden">
            <h3 style="color: var(--mk-yellow);">ü§î QU'EST-CE QUE C'EST ?</h3>
            <div style="background: #ffffff; padding: 10px; border-radius: 15px; margin-bottom: 15px; border: 4px solid var(--mk-blue);">
                <img id="img-to-guess" class="result-img" src="">
            </div>
            <input type="text" id="input-guess" placeholder="Ta r√©ponse...">
            <br><button id="btn-submit-guess" style="background: var(--mk-blue);">ENVOYER</button>
        </div>

        <div id="screen-wait" class="hidden">
            <h2 style="color: var(--mk-yellow);">BIEN JOU√â !</h2>
            <div style="font-size: 4rem;">üèéÔ∏èüí®</div>
            <p>On attend les autres pilotes...</p>
        </div>

        <div id="screen-results" class="hidden">
            <h2>üèÜ R√âSULTATS DE LA COURSE üèÜ</h2>
            <div id="results-gallery"></div>
        </div>
    </div>

    <div id="persistent-admin-panel" class="hidden">
        <div class="admin-group">
            <span style="font-weight: bold;">‚è±Ô∏è SECS:</span>
            <input type="number" id="cfg-timer" value="45" style="width:60px; font-weight: bold; border: 2px solid #000;">
            <button id="btn-start-game" class="btn-admin" style="margin: 0 0 0 10px; padding: 10px 20px;">START !</button>
        </div>
        <div class="reset-zone">
            <button id="btn-reset-round" class="btn-danger" style="font-size: 0.8rem; padding: 10px;">RESET ROUND</button>
            <button id="btn-reset-players" class="btn-danger" style="font-size: 0.8rem; padding: 10px;">RESET SALON</button>
            <button id="btn-reset-hard" style="background:#000; font-size: 0.8rem; padding: 10px;">RESET TOTAL</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, get, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCxZY1l6bfC7rXO02JtOwuauGviNSTkhYA",
            authDomain: "telephone-arabe.firebaseapp.com",
            databaseURL: "https://telephone-arabe-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "telephone-arabe",
            storageBucket: "telephone-arabe.firebasestorage.app",
            messagingSenderId: "227254624373",
            appId: "1:227254624373:web:fa1542bc7551a1083fd83c"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const myId = 'u' + Math.floor(Math.random() * 1000000);
        let myName = "", isAdmin = false, players = [], isLogged = false, tLoop = null;

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTick(freq, vol = 0.05) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.type = 'triangle'; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(vol, audioCtx.currentTime + 0.01);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.2);
            osc.start(); osc.stop(audioCtx.currentTime + 0.2);
        }

        const suggestions = ["Un Bowser en tutu", "Une banane pi√©g√©e", "Mario fait du skate", "Une carapace bleue"];

        document.getElementById('btn-join-player').onclick = () => {
            const name = document.getElementById('login-name').value;
            if(!name) return alert("ENTRE TON PR√âNOM !");
            login(name, false);
        };
        document.getElementById('btn-join-admin').onclick = () => {
            const name = document.getElementById('admin-name').value || "Maitre du Jeu";
            const pass = document.getElementById('admin-pass').value;
            if(pass === "admin") login(name, true);
            else alert("CODE INCORRECT");
        };

        function login(name, isAdm) {
            myName = name; isAdmin = isAdm; isLogged = true;
            set(ref(db, `scrum_phone/players/${myId}`), { name: myName, isAdmin: isAdm });
            onDisconnect(ref(db, `scrum_phone/players/${myId}`)).remove();
            if(isAdmin) document.getElementById('persistent-admin-panel').classList.remove('hidden');
            showScreen('screen-lobby');
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function startNewTimer(seconds) {
            if(tLoop) clearInterval(tLoop);
            let c = seconds;
            tLoop = setInterval(() => {
                c--;
                update(ref(db, 'scrum_phone'), { timer: c });
                if(c <= 0) clearInterval(tLoop);
            }, 1000);
        }

        document.getElementById('btn-start-game').onclick = () => {
            let dur = parseInt(document.getElementById('cfg-timer').value);
            update(ref(db, 'scrum_phone'), { state: "WRITE", timer: dur, maxTime: dur, books: null });
            if(isAdmin) startNewTimer(dur);
        };

        // ACTIONS RESET AVEC CORRECTION TIMER
        document.getElementById('btn-reset-round').onclick = () => {
            if(!confirm("Recommencer le round ?")) return;
            if(tLoop) clearInterval(tLoop);
            remove(ref(db, 'scrum_phone/books')); 
            update(ref(db, 'scrum_phone'), { state: "LOBBY", timer: -1 });
        };
        document.getElementById('btn-reset-players').onclick = async () => {
            if(!confirm("Vider le salon ?")) return;
            if(tLoop) clearInterval(tLoop);
            await remove(ref(db, 'scrum_phone'));
            set(ref(db, `scrum_phone/players/${myId}`), { name: myName, isAdmin: true });
            update(ref(db, 'scrum_phone'), { state: "LOBBY", timer: -1 });
        };
        document.getElementById('btn-reset-hard').onclick = () => {
            if(confirm("TOUT EFFACER ET RED√âMARRER ?")) {
                if(tLoop) clearInterval(tLoop);
                update(ref(db, 'scrum_phone'), { timer: -1, state: "LOBBY" }).then(() => {
                    remove(ref(db, 'scrum_phone')).then(() => location.reload());
                });
            }
        };

        // √âCOUTE DU TIMER AVEC S√âCURIT√â AFFICHAGE
        onValue(ref(db, 'scrum_phone/timer'), async (snap) => {
            const t = snap.val(); 
            const display = document.getElementById('timer-display');
            const container = document.getElementById('timer-container');
            const stSnap = await get(ref(db, 'scrum_phone/state'));
            const st = stSnap.val();

            // Si t est -1 ou si on est en lobby, on cache le container
            if(t !== null && t >= 0 && st !== "LOBBY" && st !== "RESULTS") {
                container.classList.remove('hidden'); 
                display.innerText = t + "s";
                if(t <= 5 && t > 0) playTick(523);
                else if(t === 0) { playTick(659, 0.08); forceSubmit(); }
                const maxSnap = await get(ref(db, 'scrum_phone/maxTime'));
                const max = maxSnap.val() || 45;
                document.getElementById('timer-progress').style.width = (t/max*100) + "%";
            } else {
                container.classList.add('hidden');
            }
        });

        onValue(ref(db, 'scrum_phone/state'), (snap) => {
            const s = snap.val(); if(!s) return;
            if(s === "LOBBY") showScreen('screen-lobby');
            if(s === "WRITE") {
                showScreen('screen-write');
                document.getElementById('phrase-suggestion').innerText = "INDICE : " + suggestions[Math.floor(Math.random()*suggestions.length)];
            }
            if(s === "DRAW") startDrawPhase();
            if(s === "GUESS") startGuessPhase();
            if(s === "RESULTS") showResults();
        });

        onValue(ref(db, 'scrum_phone/players'), (snap) => {
            const data = snap.val(); players = data ? Object.keys(data) : [];
            document.getElementById('player-list').innerHTML = data ? Object.values(data).map(p => p.name).join(" ‚Ä¢ ") : "";
        });

        function showScreen(id) {
            document.querySelectorAll('.container > div').forEach(d => { if(d.id !== 'timer-container') d.classList.add('hidden'); });
            document.getElementById(id).classList.remove('hidden');
        }

        document.getElementById('btn-submit-phrase').onclick = async () => {
            const val = document.getElementById('input-phrase').value || "Une carapace";
            showScreen('screen-wait');
            await set(ref(db, `scrum_phone/books/${myId}/step0`), { content: val, author: myName });
            checkNext("DRAW");
        };

        async function startDrawPhase() {
            const snap = await get(ref(db, `scrum_phone/books/${getTId(1)}/step0`));
            const data = snap.val() || {author: "Inconnu", content: "Rien"};
            document.getElementById('draw-instruction').innerHTML = `<b>${data.author}</b> veut que tu dessines : <br>"${data.content}"`;
            showScreen('screen-draw'); clearCanvas();
        }

        document.getElementById('btn-submit-draw').onclick = async () => {
            const data = canvas.toDataURL('image/png');
            showScreen('screen-wait');
            await set(ref(db, `scrum_phone/books/${getTId(1)}/step1`), { content: data, author: myName });
            checkNext("GUESS");
        };

        async function startGuessPhase() {
            const snap = await get(ref(db, `scrum_phone/books/${getTId(2)}/step1`));
            const data = snap.val();
            document.getElementById('img-to-guess').src = data ? data.content : "";
            showScreen('screen-guess');
        }

        document.getElementById('btn-submit-guess').onclick = async () => {
            const val = document.getElementById('input-guess').value || "???";
            showScreen('screen-wait');
            await set(ref(db, `scrum_phone/books/${getTId(2)}/step2`), { content: val, author: myName });
            checkNext("RESULTS");
        };

        async function checkNext(next) {
            if(!isAdmin) return;
            const itv = setInterval(async () => {
                const bSnap = await get(ref(db, 'scrum_phone/books'));
                const books = bSnap.val() || {};
                const step = next === "DRAW" ? "step0" : (next === "GUESS" ? "step1" : "step2");
                if(Object.values(books).filter(b => b[step]).length === players.length) {
                    clearInterval(itv);
                    const dur = parseInt(document.getElementById('cfg-timer').value);
                    update(ref(db, 'scrum_phone'), { state: next, timer: dur });
                    startNewTimer(dur);
                }
            }, 2000);
        }

        function getTId(off) { const idx = players.indexOf(myId); return players[(idx + off) % players.length]; }
        
        function forceSubmit() {
            const visible = document.querySelector('.container > div:not(.hidden)');
            if (!visible) return;
            if(visible.id === 'screen-write') document.getElementById('btn-submit-phrase').click();
            if(visible.id === 'screen-draw') document.getElementById('btn-submit-draw').click();
            if(visible.id === 'screen-guess') document.getElementById('btn-submit-guess').click();
        }

        const canvas = document.getElementById('paintCanvas'); const ctx = canvas.getContext('2d');
        let painting = false, brushColor = "#000000";
        const pal = ["#000000", "#ff0000", "#0055aa", "#43b047", "#fff200", "#ff6b6b", "#4834d4", "#6ab04c", "#be2edd", "#ffffff"];
        pal.forEach(c => {
            const dot = document.createElement('div'); dot.className = 'color-dot'; dot.style.background = c;
            dot.onclick = () => { brushColor = c; document.querySelectorAll('.color-dot').forEach(d=>d.classList.remove('active')); dot.classList.add('active'); };
            document.getElementById('palette').appendChild(dot);
            if(c === "#000000") dot.classList.add('active');
        });
        const getXY = (e) => {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: clientX - rect.left, y: clientY - rect.top };
        };
        canvas.onmousedown = canvas.ontouchstart = (e) => { painting = true; const pos = getXY(e); ctx.moveTo(pos.x, pos.y); };
        canvas.onmouseup = canvas.ontouchend = () => { painting = false; ctx.beginPath(); };
        canvas.onmousemove = canvas.ontouchmove = (e) => { 
            if (!painting) return; const pos = getXY(e);
            ctx.lineWidth = document.getElementById('brush-size').value; ctx.lineCap = 'round'; ctx.strokeStyle = brushColor;
            ctx.lineTo(pos.x, pos.y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(pos.x, pos.y);
            if(e.touches) e.preventDefault();
        };
        window.setEraser = () => brushColor = "#ffffff";
        window.clearCanvas = () => ctx.clearRect(0, 0, canvas.width, canvas.height);

        async function showResults() {
            showScreen('screen-results');
            const books = (await get(ref(db, 'scrum_phone/books'))).val();
            const gal = document.getElementById('results-gallery'); gal.innerHTML = "";
            for (let id in books) {
                const b = books[id]; if(!b.step0 || !b.step1 || !b.step2) continue;
                gal.innerHTML += `
                    <div class="result-card">
                        <div class="step-info">üèÅ D√âPART: <b>${b.step0.author}</b> a √©crit :<br>"${b.step0.content}"</div>
                        <img class="result-img" src="${b.step1.content}">
                        <div class="step-info">üé® VIRAGE: <b>${b.step1.author}</b> a illustr√©</div>
                        <div class="step-info">üèÜ ARRIV√âE: <b>${b.step2.author}</b> a devin√© :<br>"${b.step2.content}"</div>
                    </div>`;
            }
        }
    </script>
</body>
</html>
